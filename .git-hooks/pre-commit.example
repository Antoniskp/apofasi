#!/bin/bash
# Pre-commit hook to maintain code quality
# To install: cp .git-hooks/pre-commit.example .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "Running pre-commit checks..."

# Check for .env files
if git diff --cached --name-only | grep -E "\.env$"; then
  echo "‚ùå Error: Attempting to commit .env files!"
  echo "   .env files contain sensitive data and should never be committed."
  echo "   Please remove them from the commit:"
  echo "   git reset HEAD .env client/.env server/.env"
  exit 1
fi

# Check for merge conflict markers
if git diff --cached | grep -E "^(\<\<\<\<\<\<\<|\>\>\>\>\>\>\>|=======)"; then
  echo "‚ùå Error: Merge conflict markers detected!"
  echo "   Please resolve all conflicts before committing."
  exit 1
fi

# Run linter on staged files
echo "üîç Checking code style..."

# Server linting
SERVER_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^server/.*\.js$" || true)
if [ -n "$SERVER_FILES" ]; then
  echo "  Checking server files..."
  cd server
  if ! npm run lint --silent; then
    echo "‚ùå Server linting failed. Run 'cd server && npm run lint:fix' to auto-fix."
    exit 1
  fi
  cd ..
fi

# Client linting
CLIENT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^client/src/.*\.\(js\|jsx\)$" || true)
if [ -n "$CLIENT_FILES" ]; then
  echo "  Checking client files..."
  cd client
  if ! npm run lint --silent; then
    echo "‚ùå Client linting failed. Run 'cd client && npm run lint:fix' to auto-fix."
    exit 1
  fi
  cd ..
fi

echo "‚úÖ Pre-commit checks passed!"
exit 0
